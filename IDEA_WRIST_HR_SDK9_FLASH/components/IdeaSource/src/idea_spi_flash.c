#include "idea_spi_flash.h"
#include "idea_spi_master.h"
#include "nrf_gpio.h"
#include "spi_master_config.h"
#include "nrf_assert.h"
#include "string.h"
#include "simple_uart.h"


#define SPI_FLASH_CS_LOW()              nrf_gpio_pin_clear(SPI_PSELSS1)
#define SPI_FLASH_CS_HIGH()             nrf_gpio_pin_set(SPI_PSELSS1)

#define SPI_FLASH_PageSize              4096
#define SPI_FLASH_PerWritePageSize      256

/* Private define ------------------------------------------------------------*/
#define W25X_WriteEnable                0x06 
#define W25X_WriteDisable               0x04 
#define W25X_ReadStatusReg              0x05 
#define W25X_WriteStatusReg             0x01 
#define W25X_ReadData                   0x03 
#define W25X_FastReadData               0x0B 
#define W25X_FastReadDual               0x3B 
#define W25X_PageProgram                0x02 
#define W25X_BlockErase                 0xD8 
#define W25X_SectorErase                0x20 
#define W25X_ChipErase                  0xC7 
#define W25X_PowerDown                  0xB9 
#define W25X_ReleasePowerDown           0xAB 
#define W25X_DeviceID                   0xAB 
#define W25X_ManufactDeviceID           0x90 
#define W25X_JedecDeviceID              0x9F 

uint8_t spim_dma_txbuf[8]           = {0};
uint8_t spim_dma_rxbuf[260]         = {0};
uint8_t write_flash_page[256];


// Num_0824
const uint8_t Num_0824[256] = 
{
    0x00,0x80,0xF0,0x7C,0x0C,0x7C,0xF0,0x80,0x00,0x70,0x70,0xFC,0xFC,0x00,0x00,0x00,
    0x00,0xF0,0xFC,0x0C,0x0C,0xFC,0xF0,0x00,0x00,0xF0,0xFC,0x0C,0x0C,0xFC,0xF0,0x00,
    0x00,0x00,0x80,0xF0,0xFC,0xFC,0x00,0x00,0x00,0xFC,0xFC,0x0C,0x0C,0x0C,0x0C,0x00,
    0x80,0xF0,0x7C,0x0C,0x0C,0x7C,0x7C,0x00,0x00,0xFC,0xFC,0x0C,0x8C,0xFC,0x7C,0x00,
    0xF0,0xFC,0x0C,0x0C,0x0C,0xFC,0xF0,0x00,0xF0,0xFC,0x0C,0x0C,0x0C,0xFC,0xF0,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,
    0xFF,0xFF,0x00,0x00,0x00,0x00,0x01,0x81,0xE0,0x78,0x1F,0x07,0x00,0x00,0x81,0x81,
    0x06,0x06,0xFF,0xF9,0x00,0x60,0xFE,0x9F,0x81,0xFF,0xFF,0x80,0x00,0x00,0x9F,0x9F,
    0x06,0x06,0xFE,0xF8,0x00,0xFF,0xFF,0x1E,0x06,0x06,0xFE,0xF8,0x00,0x00,0x01,0x01,
    0xF8,0xFF,0x07,0x00,0x00,0xE1,0xFF,0x1E,0x18,0x1E,0xFF,0xE1,0x00,0x1F,0x7F,0x60,
    0x60,0x78,0xFF,0xFF,0x00,0x00,0x8C,0x8C,0x00,0x00,0x00,0x01,0x0F,0x3E,0x30,0x3E,
    0x0F,0x01,0x00,0x30,0x30,0x3F,0x3F,0x30,0x30,0x00,0x00,0x3E,0x3F,0x31,0x30,0x3E,
    0x3E,0x00,0x00,0x0F,0x3F,0x30,0x30,0x3F,0x0F,0x00,0x00,0x01,0x01,0x31,0x3F,0x3F,
    0x31,0x00,0x00,0x0F,0x3F,0x30,0x30,0x3F,0x0F,0x00,0x0F,0x3F,0x30,0x30,0x30,0x3F,
    0x0F,0x00,0x00,0x00,0x00,0x3F,0x3F,0x00,0x00,0x00,0x0F,0x3F,0x30,0x30,0x30,0x3F,
    0x0F,0x00,0x3E,0x3E,0x30,0x30,0x3E,0x0F,0x01,0x00,0x00,0x01,0x01,0x00,0x00,
};


// Num0805_battery_blutooth
const uint8_t Num0805_battery_blutooth[256] = 
{
    0x3C,0x42,0x42,0x3C,0x00,0x00,0x44,0x7E,0x40,0x00,0x66,0x52,0x4A,0x46,0x00,0x42,
    0x4A,0x4A,0x7E,0x00,0x1E,0x10,0x10,0x7E,0x00,0x6E,0x4A,0x4A,0x7A,0x00,0x7E,0x4A,
    0x4A,0x7A,0x00,0x06,0x62,0x1A,0x06,0x00,0x7E,0x52,0x52,0x7E,0x00,0x5E,0x52,0x52,
    0x7E,0x00,0x40,0x30,0x0C,0x02,0x00,0x44,0x30,0x0C,0x22,0x00,                        // 前 60个数据表示0805的数字
    0x7E,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x7E,0x24,0x3C,0x00,0x7E,
    0x7E,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x7E,0x24,0x3C,0x00,0x7E,0x7E,
    0x7E,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x7E,0x24,0x3C,0x00,0x7E,0x7E,0x7E,
    0x7E,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x7E,0x24,0x3C,0x00,0x7E,0x7E,0x7E,0x7E,
    0x7E,0x42,0x42,0x42,0x42,0x42,0x42,0x7E,0x24,0x3C,0x00,0x7E,0x7E,0x7E,0x7E,0x7E,
    0x7E,0x42,0x42,0x42,0x42,0x42,0x7E,0x24,0x3C,0x00,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,
    0x7E,0x42,0x42,0x42,0x42,0x7E,0x24,0x3C,0x00,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,
    0x7E,0x42,0x42,0x42,0x7E,0x24,0x3C,0x00,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,
    0x7E,0x42,0x42,0x7E,0x24,0x3C,0x00,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,
    0x7E,0x42,0x7E,0x24,0x3C,0x00,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,
    0x7E,0x7E,0x3C,0x3C,0x00,                                                           // 此 165个数据表示battery
    0x00,0x22,0x14,0xFF,0x99,0x5A,0x24,0x00,0x00,0xA2,0x54,0xFF,0x9D,0x5A,0x25,0x00,    // 此16个数据为蓝牙标志

};

// step_distence_calorie
const uint8_t step_distence_calorie[256] = 
{
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0xF8,0xFC,0xFC,0xFC,
    0xFC,0xF8,0xF0,0x00,0x00,0x00,0x00,0x00,0xC0,0xF0,0xF8,0xF8,0xFC,0x7E,0x3E,0x7E,
    0xFC,0xF8,0xF8,0xF0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0xC0,0xE0,0xF0,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0xE0,0xF0,0xF8,0xF8,0xF8,0xF8,0xF8,0xF0,0x80,0x00,0x1F,0x3F,0x3F,0x3F,0x3F,
    0x3F,0x3F,0x3F,0x00,0x00,0x00,0x00,0x00,0x01,0x07,0x1F,0x3F,0x7F,0xFE,0xFC,0xFE,
    0x7F,0x3F,0x1F,0x07,0x01,0x00,0x00,0x00,0x00,0x00,0xE0,0xC0,0xE0,0xFC,0xFE,0xFF,
    0xFF,0xFF,0xFF,0xFF,0xFF,0xF8,0xF0,0xF8,0xF8,0xE0,0x80,0x00,0x00,0x00,0x00,0x00,
    0x00,0x3F,0x7F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x03,0x00,0x1F,0x3F,0x3F,0x3F,0x3F,
    0x3F,0x1F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xF0,0xF8,0xF8,0xF8,0x69,0xF8,
    0xF8,0xF8,0xE0,0xC0,0x00,0x00,0x00,0x00,0x00,0x3F,0xFF,0xFF,0xFF,0xFF,0xFF,0x07,
    0x03,0x00,0x01,0x03,0x07,0xFF,0xFF,0xFF,0xFF,0xFF,0x3F,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x1E,0x3E,0x7E,0x7E,0x7F,0x7F,0x3F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x30,0x38,0x3E,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x26,0x3F,
    0x3F,0x3F,0x3F,0x3F,0x3F,0x3E,0x38,0x30,0x00,0x00,0x00,0x01,0x01,0x03,0x03,0x02,
    0x00,0x00,0x00,0x02,0x03,0x03,0x03,0x03,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};


// heart_rate
const uint8_t heart_rate[256] = 
{
    0x00,0x00,0x00,0xC0,0xE0,0xF0,0xF0,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF0,0xF0,0xE0,
    0xC0,0xE0,0xF0,0xF0,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF0,0xF0,0xE0,0x80,0x00,0x00,
    0x00,0x00,0x00,0xC0,0xE0,0xF0,0xF0,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF0,0xF0,0xE0,
    0xC0,0xE0,0xF0,0xF0,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF0,0xF0,0xE0,0x80,0x00,0x00,
    0x00,0x00,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x1C,0x00,
    0x00,0x00,0x7F,0xFF,0xFF,0xFF,0x3F,0x0F,0x3F,0xFF,0x7F,0x7F,0x7F,0x8F,0xC3,0x03,
    0xFF,0xFF,0x7F,0x7F,0xFF,0xFF,0x1F,0xC3,0x8F,0x7F,0x7F,0x7F,0x7F,0x7F,0x1C,0x00,
    0x00,0x00,0x00,0x01,0x07,0x0F,0x3F,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x7F,0x3F,0x1F,0x0F,0x07,0x01,0x00,0x00,
    0x00,0x00,0x00,0x01,0x05,0x0D,0x3E,0x7F,0xFC,0xF8,0xFE,0xFC,0xFE,0xFF,0xFF,0xFC,
    0x81,0xC3,0xFC,0xFC,0xF1,0xF8,0xFF,0xFF,0x7F,0x3F,0x1F,0x0F,0x07,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x03,0x03,0x07,0x0F,0x1F,0x3F,
    0x3F,0x1F,0x1F,0x0F,0x07,0x03,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x03,0x03,0x07,0x0F,0x1F,0x3F,
    0x3F,0x1F,0x1F,0x0F,0x07,0x03,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};


// Haterate
const uint8_t Haterate[256] = 
{
    0x00,0x00,0x00,0xC0,0xE0,0xF0,0xF0,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF0,0xF0,0xE0,
    0xC0,0xE0,0xF0,0xF0,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF0,0xF0,0xE0,0x80,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x7F,0xFF,0xFF,0xFF,0x3F,0x0F,0x3F,0xFF,0x7F,0x7F,0x7F,0x8F,0xC3,0x03,
    0xFF,0xFF,0x7F,0x7F,0xFF,0xFF,0x1F,0xC3,0x8F,0x7F,0x7F,0x7F,0x7F,0x7F,0x1C,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0xFC,0x0C,0x0C,0x0C,0xFC,0xF0,0x00,0xF0,0xFC,
    0x0C,0x0C,0x0C,0xFC,0xF0,0x00,0xF0,0xFC,0x0C,0x0C,0x0C,0xFC,0xF0,0x00,0x00,0x00,
    0x00,0x00,0x00,0x01,0x05,0x0D,0x3E,0x7F,0xFC,0xF8,0xFE,0xFC,0xFE,0xFF,0xFF,0xFC,
    0x81,0xC3,0xFC,0xFC,0xF1,0xF8,0xFF,0xFF,0x7F,0x3F,0x1F,0x0F,0x07,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x1F,0x7F,0x60,0x60,0x78,0xFF,0xFF,0x00,0x1F,0x7F,
    0x60,0x60,0x78,0xFF,0xFF,0x00,0x1F,0x7F,0x60,0x60,0x78,0xFF,0xFF,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x03,0x03,0x07,0x0F,0x1F,0x3F,
    0x3F,0x1F,0x1F,0x0F,0x07,0x03,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x3E,0x3E,0x30,0x30,0x3E,0x0F,0x01,0x00,0x3E,0x3E,
    0x30,0x30,0x3E,0x0F,0x01,0x00,0x3E,0x3E,0x30,0x30,0x3E,0x0F,0x01,0x00,0x00,0x00
};

// lowpower
const uint8_t lowpower[256] = 
{
    0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xE0,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,
    0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0xE0,0xE0,
    0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,
    0x60,0x60,0x60,0x60,0xE0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1C,0xFF,0xFF,0xFF,0xFF,
    0xFF,0xFF,0x0C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x0F,0x0F,0x0C,0xFC,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0xF3,0xF3,0xF3,
    0xF3,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0xF0,0xF0,0x30,0x3F,0x1F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x07,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,
    0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x07,0x07,
    0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,
    0x06,0x06,0x06,0x06,0x07,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};

// charging
const uint8_t charging[256] = 
{
    0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xE0,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,
    0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,
    0xE0,0xE0,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,
    0x60,0x60,0x60,0x60,0xE0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xC0,0xE0,0xF0,0xF8,0xFC,0xFE,0xEF,
    0xE3,0xE0,0x60,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x0F,0x0F,0x0C,0xFC,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0xF1,0x7F,0x3F,0x1F,0x0F,0x07,0x03,
    0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0xF0,0xF0,0x30,0x3F,0x1F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x07,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,
    0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,
    0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,
    0x06,0x06,0x06,0x06,0x07,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};



// chargfull
const uint8_t chargfull[256] = 
{
    0x00,0x00,0x00,0x00,0x00,0xC0,0xE0,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,
    0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,
    0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,
    0x60,0x60,0x60,0x60,0xE0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    0xFF,0xFF,0xFF,0xF0,0xEF,0xEF,0x0C,0xFC,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    0xFF,0xFF,0xFF,0x0F,0xF7,0xF7,0x30,0x3F,0x1F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x03,0x07,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,
    0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,
    0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,
    0x06,0x06,0x06,0x06,0x07,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};


void spi_flash_init(void)
{
    uint32_t *spi_base_address = spi_master_init(SPI1,SPI_MODE0,false);
    if (spi_base_address == 0) {
        return;
    };
    spi_master_enable(SPI1);
    //spi_master_disable(SPI1);
}

/*******************************************************************************
* Function Name  : SPI_FLASH_WriteEnable
* Description    : Enables the write access to the FLASH.
* Input          : None
* Output         : None
* Return         : None
*******************************************************************************/
void SPI_FLASH_WriteEnable(void)
{
    spi_master_enable(SPI1);
    uint32_t err;
    SPI_FLASH_CS_HIGH();
    /* Select the FLASH: Chip Select low */
    SPI_FLASH_CS_LOW();

    /* Send "Write Enable" instruction */
    //SPI_FLASH_SendByte(W25X_WriteEnable);
    spim_dma_txbuf[0] = W25X_WriteEnable;
    ASSERT(spi_master_tx_rx((uint32_t *)NRF_SPI1,1,spim_dma_txbuf,spim_dma_rxbuf));
    spi_master_disable(SPI1);
}

void SPI_FLASH_Erase_Sector(uint32_t nDest)
{
    spi_master_enable(SPI1);
    nDest *= SPI_FLASH_PageSize;

    spim_dma_txbuf[0] = W25X_SectorErase;
    spim_dma_txbuf[1] = (uint8_t)((nDest & 0xFFFFFF) >> 16);
    spim_dma_txbuf[2] = (uint8_t)((nDest & 0xFFFF) >> 8);
    spim_dma_txbuf[3] = (uint8_t)nDest & 0xFF;
    SPI_FLASH_CS_HIGH();
    /* Select the FLASH: Chip Select low */
    SPI_FLASH_CS_LOW();
    ASSERT(spi_master_tx_rx((uint32_t *)NRF_SPI1,4,spim_dma_txbuf,spim_dma_rxbuf));
    spi_master_disable(SPI1);
}

/*******************************************************************************
* Function Name  : SPI_FLASH_PageWrite
* Description    : Writes more than one byte to the FLASH with a single WRITE
*                  cycle(Page WRITE sequence). The number of byte can't exceed
*                  the FLASH page size.
* Input          : - pBuffer : pointer to the buffer  containing the data to be
*                    written to the FLASH.
*                  - WriteAddr : FLASH's internal address to write to.
*                  - NumByteToWrite : number of bytes to write to the FLASH,
*                    must be equal or less than "SPI_FLASH_PageSize" value.
* Output         : None
* Return         : None
*******************************************************************************/
void SPI_FLASH_PageWrite(uint8_t* pBuffer, uint32_t WriteAddr, uint16_t NumByteToWrite,uint8_t offset)
{
    spi_master_enable(SPI1);
    uint32_t err;
    uint32_t add;
    add = WriteAddr * SPI_FLASH_PerWritePageSize + offset;
     /* Chip Select high */
    SPI_FLASH_CS_HIGH();
//    spim_dma_buffer[0] = W25X_WriteEnable;                  // Enable the write access to the FLASH 
    spim_dma_txbuf[0] = W25X_PageProgram;                  // Page Program Command
    spim_dma_txbuf[1] = (add & 0xFF0000) >> 16;      // Add bit23~bit16
    spim_dma_txbuf[2] = (add & 0x00FF00) >> 8;       // Add bit15~bit8
    spim_dma_txbuf[3] = (add & 0x0000FF) >> 0;       // Add bit7~bit0
    
    for(uint16_t i=0;i<NumByteToWrite;i++)
    {
        spim_dma_txbuf[4+i] = pBuffer[i];
    }
    
    /* Select the FLASH: Chip Select low */
    SPI_FLASH_CS_LOW();
    ASSERT(spi_master_tx_rx((uint32_t *)NRF_SPI1,NumByteToWrite + 4,spim_dma_txbuf,spim_dma_rxbuf));
    spi_master_disable(SPI1);
}

/*******************************************************************************
* Function Name  : SPI_FLASH_PageRead
* Description    : Read a page to the FLASH with a single Read
*                  cycle(Page Read sequence). The number of byte can't exceed
*                  a FLASH page size.
* Input          : - pBuffer : pointer to the buffer  containing the data to be
*                    Read from the FLASH.
*                  - ReadAddr : FLASH's internal address to write to.
*                  - NumByteToWrite : number of bytes to read from the FLASH,
*                    must be equal or less than "SPI_FLASH_PageSize" value.
* Output         : None
* Return         : None
*******************************************************************************/
void SPI_FLASH_PageRead(uint32_t ReadAddr, uint16_t NumByteToRead, uint8_t offset)
{
    spi_master_enable(SPI1);
    uint32_t err;
    uint32_t add;
    add = ReadAddr * SPI_FLASH_PerWritePageSize + offset;
     /* Chip Select high */
    SPI_FLASH_CS_HIGH();
    spim_dma_txbuf[0] = W25X_ReadData;               // Read Data Bytes Command
    spim_dma_txbuf[1] = (add & 0xFF0000) >> 16;      // Add bit23~bit16
    spim_dma_txbuf[2] = (add & 0x00FF00) >> 8;       // Add bit15~bit8
    spim_dma_txbuf[3] = (add & 0x0000FF) >> 0;       // Add bit7~bit0
    
    /* Select the FLASH: Chip Select low */
    SPI_FLASH_CS_LOW();
    ASSERT(spi_master_tx_rx((uint32_t *)NRF_SPI1,NumByteToRead + 4,spim_dma_txbuf,spim_dma_rxbuf));
    
    spi_master_disable(SPI1);
}

